{% extends "base.html" %}
{% block title %}Patient Dashboard{% endblock %}
{% block content %}
<h2>Welcome to Your Patient Dashboard</h2>

<!-- Tabs -->
<div class="tabs">
  <button class="tab-btn active" onclick="showTab('appointments')">My Appointments</button>
  <button class="tab-btn" onclick="showTab('reports')">My Reports</button>
  <button class="tab-btn" onclick="showTab('book')">Book Appointment</button>
  <button class="tab-btn" onclick="showTab('emergency')">Emergency</button>
</div>

<!-- APPOINTMENTS TAB -->
<div id="appointments" class="tab-content active">
  <h3>My Appointments</h3>
  <ul>
    {% for h in history %}
      <li><strong>{{ h.get('Date') }}</strong> â€” {{ h.get('Problem') }} ({{ h.get('Status','Pending') }})</li>
    {% else %}
      <li>No previous appointments found.</li>
    {% endfor %}
  </ul>

  <h3>Upcoming Checkups</h3>
  {% if upcoming %}
    <ul>
      <li>
        <strong>{{ upcoming.get('Date') }}</strong> at {{ upcoming.get('Time') }}
        â€” {{ upcoming.get('Problem') }}
        with Dr. {{ upcoming.get('Doctor') }}
      </li>
    </ul>
  {% else %}
    <p>No upcoming checkups scheduled.</p>
  {% endif %}
</div>

<!-- REPORTS TAB -->
<div id="reports" class="tab-content">
  <h3>My Uploaded Reports</h3>
  <div class="report-grid">
    {% if reports %}
      {% for r in reports %}
        <div class="report-card">
          <div class="report-info">
            <b>Date:</b> {{ r.get('Date') }}<br>
            <b>Doctor:</b> Dr. {{ r.get('Doctor') }}
          </div>

          {% if r.get('File') %}
            {% set ext = r.get('File').split('.')[-1].lower() %}
            {% if ext in ['jpg', 'jpeg', 'png'] %}
              <div class="report-preview">
                <a href="/uploads/{{ r.get('File') }}" target="_blank">
                  <img src="/uploads/{{ r.get('File') }}" alt="{{ r.get('File') }}">
                </a>
              </div>
            {% else %}
              <div class="report-file">
                <a href="/uploads/{{ r.get('File') }}" target="_blank">ðŸ“Ž Download {{ r.get('File') }}</a>
              </div>
            {% endif %}
          {% elif r.get('Details') %}
            <div class="report-text">
              <p>{{ r.get('Details') }}</p>
            </div>
          {% else %}
            <div class="report-text">
              <p><i>No report details available.</i></p>
            </div>
          {% endif %}
        </div>
      {% endfor %}
    {% else %}
      <p>No reports available yet.</p>
    {% endif %}
  </div>
</div>

<!-- BOOK APPOINTMENT TAB -->
<div id="book" class="tab-content">
  <h3>Book Appointment</h3>
  <form method="post" action="/patient/book">

    <input name="name" value="{{ session.get('username') }}" placeholder="Name" required>
    <input name="age" placeholder="Age" required>
    <input name="gender" placeholder="Gender" required>
    <input type="date" name="date" required>

    <!-- Time dropdown -->
    <select name="time" required>
      {% for hour in range(9, 12) %}
        {% for minute in [0,10,20,30,40,50] %}
          <option value="{{ '%02d:%02d' % (hour, minute) }}">
            {{ '%02d:%02d' % (hour, minute) }}
          </option>
        {% endfor %}
      {% endfor %}

      {% for hour in range(14, 18) %}
        {% for minute in [0,10,20,30,40,50] %}
          <option value="{{ '%02d:%02d' % (hour, minute) }}">
            {{ '%02d:%02d' % (hour, minute) }}
          </option>
        {% endfor %}
      {% endfor %}
    </select>

    <!-- Problem dropdown -->
    <select name="problem" required>
      <option value="Heart">Heart (Cardiologist)</option>
      <option value="Fever">Fever (General Physician)</option>
      <option value="Skin">Skin (Dermatologist)</option>
      <option value="Diabetes">Diabetes (Endocrinologist)</option>
      <option value="Bone">Bone / Orthopedic</option>
      <option value="Can't say">Can't say</option>
    </select>

    <button class="btn primary">Book</button>
  </form>
</div>

<!-- EMERGENCY TAB -->
<div id="emergency" class="tab-content">
  <h3>Emergency</h3>
  <form method="post" action="/patient/emergency">
    <input name="name" value="{{ session.get('username') }}" placeholder="Name" required>
    <input name="age" placeholder="Age" required>
    <input name="gender" placeholder="Gender" required>

    <select name="problem" required>
      <option value="Heart">Heart (Cardiologist)</option>
      <option value="Fever">Fever (General Physician)</option>
      <option value="Skin">Skin (Dermatologist)</option>
      <option value="Diabetes">Diabetes (Endocrinologist)</option>
      <option value="Bone">Bone / Orthopedic</option>
      <option value="Can't say">Can't say</option>
    </select>

    <button class="btn danger">Report Emergency</button>
  </form>
</div>

{% raw %}
<script>
function showTab(tabId) {
  document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
  document.querySelector(`.tab-btn[onclick="showTab('${tabId}')"]`).classList.add('active');
  document.getElementById(tabId).classList.add('active');
}
</script>
{% endraw %}

<style>
.tabs { display: flex; gap: 10px; margin-bottom: 20px; }
.tab-btn { background: #e5e7eb; border: none; padding: 10px 15px; border-radius: 8px; cursor: pointer; font-weight: 600; }
.tab-btn.active { background: #3b82f6; color: white; }
.tab-content { display: none; }
.tab-content.active { display: block; }

form input, form textarea, form select {
  display: block;
  margin: 8px 0;
  padding: 8px;
  width: 100%;
  border-radius: 6px;
  border: 1px solid #ccc;
}

.btn { padding: 8px 15px; border: none; border-radius: 6px; cursor: pointer; }
.btn.primary { background: #3b82f6; color: white; }
.btn.danger { background: #dc2626; color: white; }

/* Report grid */
.report-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
  gap: 20px;
  margin-top: 15px;
}
.report-card {
  background: #f9fafb;
  border: 1px solid #ddd;
  border-radius: 12px;
  padding: 15px;
  text-align: center;
  box-shadow: 0 2px 5px rgba(0,0,0,0.05);
  transition: 0.2s;
}
.report-card:hover {
  transform: scale(1.02);
}
.report-preview img {
  width: 100%;
  height: 180px;
  object-fit: cover;
  border-radius: 8px;
}
.report-file a {
  padding: 6px 10px;
  background: #3b82f6;
  color: #fff;
  border-radius: 6px;
  text-decoration: none;
}
.report-text {
  background: white;
  padding: 10px;
  border-radius: 8px;
}
.report-info { margin-bottom: 10px; }
</style>

{% endblock %}
