{% extends "base.html" %}
{% block title %}Patient Dashboard{% endblock %}
{% block content %}
<h2>Welcome to Your Patient Dashboard</h2>

<!-- Tabs -->
<div class="tabs">
  <button class="tab-btn active" onclick="showTab('appointments')">My Appointments</button>
  <button class="tab-btn" onclick="showTab('reports')">My Reports</button>
  <button class="tab-btn" onclick="showTab('book')">Book Appointment</button>
  <button class="tab-btn" onclick="showTab('emergency')">Emergency</button>
</div>

<!-- APPOINTMENTS TAB -->
<div id="appointments" class="tab-content active">
  <h3>My Appointments</h3>
  <ul>
    {% for h in history %}
      <li><strong>{{ h['Date'] }}</strong> â€” {{ h['Problem'] }} ({{ h['Status'] or 'Pending' }})</li>
    {% else %}
      <li>No previous appointments found.</li>
    {% endfor %}
  </ul>

  <h3>Upcoming Checkups</h3>
  {% if upcoming %}
    <ul>
      <li><strong>{{ upcoming['Date'] }}</strong> at {{ upcoming['Time'] }} â€” {{ upcoming['Problem'] }} with Dr. {{ upcoming['Doctor'] }}</li>
    </ul>
  {% else %}
    <p>No upcoming checkups scheduled.</p>
  {% endif %}
</div>

<!-- REPORTS TAB -->
<div id="reports" class="tab-content">
  <h3>My Uploaded Reports</h3>
  <div class="report-grid">
    {% if reports %}
      {% for r in reports %}
        <div class="report-card">
          <div class="report-info">
            <b>Date:</b> {{ r.Date }}<br>
            <b>Doctor:</b> Dr. {{ r.Doctor }}
          </div>

          {% if r.File %}
            {% set ext = r.File.split('.')[-1].lower() %}
            {% if ext in ['jpg', 'jpeg', 'png'] %}
              <div class="report-preview">
                <a href="/uploads/{{ r.File }}" target="_blank">
                  <img src="/uploads/{{ r.File }}" alt="{{ r.File }}">
                </a>
              </div>
            {% else %}
              <div class="report-file">
                <a href="/uploads/{{ r.File }}" target="_blank">ðŸ“Ž Download {{ r.File }}</a>
              </div>
            {% endif %}
          {% elif r.Details %}
            <div class="report-text">
              <p>{{ r.Details }}</p>
            </div>
          {% else %}
            <div class="report-text">
              <p><i>No report details available.</i></p>
            </div>
          {% endif %}
        </div>
      {% endfor %}
    {% else %}
      <p>No reports available yet.</p>
    {% endif %}
  </div>
</div>

<!-- BOOK APPOINTMENT TAB -->
<div id="book" class="tab-content">
  <h3>Book Appointment</h3>
  <form method="post" action="/patient/book">
    <input name="name" value="{{ session.get('username') }}" placeholder="Name" required>
    <input name="age" placeholder="Age" required>
    <input name="gender" placeholder="Gender" required>
    <input type="date" name="date" required>
        <select name="time" required>
    {% set times = [] %}
    {% for hour in range(9, 12) %}
        {% for minute in range(0, 60, 10) %}
        {% set h = "%02d" % hour %}
        {% set m = "%02d" % minute %}
        {% set t = h ~ ":" ~ m %}
        {% set _ = times.append(t) %}
        {% endfor %}
    {% endfor %}
    {% for hour in range(14, 18) %}
        {% for minute in range(0, 60, 10) %}
        {% set h = "%02d" % hour %}
        {% set m = "%02d" % minute %}
        {% set t = h ~ ":" ~ m %}
        {% set _ = times.append(t) %}
        {% endfor %}
    {% endfor %}
    {% for t in times %}
        <option value="{{ t }}">{{ t }}</option>
    {% endfor %}
    </select>
    <textarea name="problem" placeholder="Describe your problem" required></textarea>
    <button class="btn primary">Book</button>
  </form>
</div>

<!-- EMERGENCY TAB -->
<div id="emergency" class="tab-content">
  <h3>Emergency</h3>
  <form method="post" action="/patient/emergency">
    <input name="name" value="{{ session.get('username') }}" placeholder="Name" required>
    <input name="age" placeholder="Age" required>
    <input name="gender" placeholder="Gender" required>
    <textarea name="problem" placeholder="Describe the emergency" required></textarea>
    <button class="btn danger">Report Emergency</button>
  </form>
</div>

{% raw %}
<script>
function showTab(tabId) {
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
  document.querySelector(`.tab-btn[onclick="showTab('${tabId}')"]`).classList.add('active');
  document.getElementById(tabId).classList.add('active');
}
</script>
{% endraw %}

<style>
.tabs { display: flex; gap: 10px; margin-bottom: 20px; }
.tab-btn { background: #e5e7eb; border: none; padding: 10px 15px; border-radius: 8px; cursor: pointer; font-weight: 600; }
.tab-btn.active { background: #3b82f6; color: white; }
.tab-content { display: none; }
.tab-content.active { display: block; }

form input, form textarea, form select {
  display: block;
  margin: 8px 0;
  padding: 8px;
  width: 100%;
  border-radius: 6px;
  border: 1px solid #ccc;
}
.btn { padding: 8px 15px; border: none; border-radius: 6px; cursor: pointer; }
.btn.primary { background: #3b82f6; color: white; }
.btn.danger { background: #dc2626; color: white; }

/* Report Grid Layout */
.report-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
  gap: 20px;
  margin-top: 15px;
}
.report-card {
  background: #f9fafb;
  border: 1px solid #ddd;
  border-radius: 12px;
  padding: 15px;
  box-shadow: 0 2px 5px rgba(0,0,0,0.05);
  text-align: center;
  transition: transform 0.2s ease, box-shadow 0.2s ease;
}
.report-card:hover {
  transform: scale(1.02);
  box-shadow: 0 4px 10px rgba(0,0,0,0.1);
}
.report-preview img {
  width: 100%;
  height: 180px;
  object-fit: cover;
  border-radius: 8px;
}
.report-file a {
  display: inline-block;
  background: #3b82f6;
  color: white;
  padding: 6px 10px;
  border-radius: 6px;
  text-decoration: none;
}
.report-text {
  background: #fff;
  border-radius: 8px;
  padding: 10px;
  color: #333;
  font-size: 0.95em;
}
.report-info {
  margin-bottom: 10px;
  font-size: 0.9em;
  color: #444;
}
</style>
{% endblock %}
